---
title: 'Discord ã® Web èªè¨¼ã‚’ä½œã‚‹ | Next.js'
published: true
type: tech
emoji: 'âœ…'
topics: ['nextjs', 'react', 'discord', 'oauth2']
---

## ã¯ã˜ã‚ã«

æœ¬è¨˜äº‹ã§ã¯ Next.js, Discord ã® Oauth2 ã‚’çµ„ã¿åˆã‚ã›ã¦ Discord ã‚µãƒ¼ãƒãƒ¼ã«èªè¨¼ãƒ‘ãƒãƒ«ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã‚’å…±æœ‰ã—ã¾ã™ã€‚
è’ã‚‰ã—å¯¾ç­–ã‚„ã€ã‚µãƒ¼ãƒãƒ¼å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ç®¡ç†ã™ã‚‹ã®ã«ä¾¿åˆ©ã§ã™ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚  
https://github.com/yuk228/Discord-Oauth2-Web-Verify

### èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®ä¸»ãªå‹•ä½œãƒ•ãƒ­ãƒ¼

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Discord ã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ 
2. Cloudflare Turnstile ã§äººé–“ã‹ç¢ºèª
3. Discord OAuth 2 ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
4. æŒ‡å®šã—ãŸãƒ­ãƒ¼ãƒ«ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä»˜ä¸
5. èªè¨¼å®Œäº†ãƒ­ã‚°ã‚’é€ä¿¡

### Cloudflare Turnstile ã¨ã¯

Cloudflare Turnstile ã¯ã€ä»¥ä¸‹ã®ç”»åƒã®ã‚ˆã†ãªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å‹ã®ãƒœãƒƒãƒˆå¯¾ç­–ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/8808030b053c-20250601.png)

é¢å€’ãªç”»åƒèªè¨¼ã‚’è§£ãå¿…è¦ãŒãªãã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã ã‘ã§ãƒœãƒƒãƒˆã‹ã©ã†ã‹ã‚’åˆ¤å®šã§ãã¾ã™

:::message
ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’è‡ªå‹•çš„ã«çªç ´ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹([capsolver](https://www.capsolver.com/), [capmonster](https://capmonster.cloud/en)`ãªã©)ãŒå­˜åœ¨ã—ã¾ã™ã€‚
Turnstile ã¯çªç ´ã™ã‚‹ã®ãŒé›£ã—ã„ã‚‰ã—ãã€reCAPTCHA ã‚„ hCaptcha ã‚ˆã‚Šã‚‚è‡ªå‹•è§£æ±ºã®ã‚³ã‚¹ãƒˆãŒé«˜ã„ã§ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®è¦³ç‚¹ã‹ã‚‰ã‚‚ Turnsitle ã®ä½¿ç”¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
:::

## ç’°å¢ƒæ§‹ç¯‰

### Bun ã‚’å…¥ã‚Œã‚ˆã†(å¸ƒæ•™)

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ã¯`bun`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
`pnpm`ã‚„`npm`ã‚ˆã‚Šã‚‚é«˜é€Ÿã§ãŠå‹§ã‚ã§ã™ã€‚

```bash:macos&linux
curl -fsSL https://bun.com/install | bash
```

```bash:windows
powershell -c "irm bun.sh/install.ps1|iex"
```

https://bun.com/docs/installation

### Next.js ã®åˆæœŸåŒ–

```bash
bun create next-app@latest discord-auth \
  --typescript --eslint --tailwind --app --import-alias "@/*" --use-turbopack

cd discord-auth
```

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

#### iron-session

```bash
bun add iron-session
```

`iron-session` ã¯ Cookie ã‚’åˆ©ç”¨ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ `AES-256-CBC` ã§æš—å·åŒ–ã•ã‚Œã¾ã™ã€‚
è©³ã—ãã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚  
https://qiita.com/aurora1530/items/015cdef0fc9c8033c949

#### next-turnstile

```bash
bun add next-turnstile
```

`next-turnstile` ã¯ã€Next.js ç”¨ã® Cloudflare Turnstile çµ±åˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ä¸¡æ–¹ã§å‹•ä½œã—ã€ç°¡å˜ã«å°å…¥ã§ãã¾ã™ã€‚  
https://github.com/JedPattersonn/next-turnstile

#### shadcn/ui

```bash
bunx --bun shadcn@latest init
bunx --bun shadcn@latest add button
```

`shadcn/ui` ã¯ãƒ¢ãƒ€ãƒ³ã§ç¾ã—ã„ UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æä¾›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚ä»Šå›ã¯ Button ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚  
https://ui.shadcn.com/docs/installation/next

## äº‹å‰æº–å‚™

### Discord Developer Portal

Discord Developer Portal ã§ Bot ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

1. ã€ŒOAuth 2ã€ã®ã€ŒRedirectsã€ã« `https://localhost:3000/api/callback` ã‚’å…¥åŠ›
2. ã€ŒOAuth 2 URL Generatorã€ã§ `identify` ã«ãƒã‚§ãƒƒã‚¯
3. ç”Ÿæˆã•ã‚ŒãŸ URL ã‚’ã‚³ãƒ”ãƒ¼

ã“ã® URL ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ™‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚  
https://discord.com/developers/applications

### ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `.env.local` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

```env
# Discord OAuth2
CLIENT_ID=              # Discord Developer Portal ã‹ã‚‰å–å¾—
CLIENT_SECRET=          # åŒä¸Š
BASE_URL=http://localhost:3000

# Discord ã‚µãƒ¼ãƒãƒ¼
DISCORD_GUILD_ID=       # å¯¾è±¡ã‚µãƒ¼ãƒãƒ¼ã® ID
DISCORD_ROLE_ID=        # èªè¨¼æˆåŠŸæ™‚ã«ä»˜ä¸ã™ã‚‹ãƒ­ãƒ¼ãƒ« ID
DISCORD_BOT_TOKEN=      # Bot ãƒˆãƒ¼ã‚¯ãƒ³
DISCORD_WEBHOOK=        # èªè¨¼ãƒ­ã‚°ç”¨ Webhook URL

# Cloudflare Turnstile
NEXT_PUBLIC_TURNSTILE_SITE_KEY=  # Cloudflare ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰å–å¾—
TURNSTILE_SECRET_KEY=            # åŒä¸Š

# Session
SESSION_PASSWORD=                # 32 æ–‡å­—ã®ãƒ©ãƒ³ãƒ€ãƒ è‹±æ•°å­—
```

:::message
Discord Webhook ã®ä½œæˆæ–¹æ³•ï¼š

1. Discord ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šã‚’é–‹ã
2. ã€Œé€£æºã‚µãƒ¼ãƒ“ã‚¹ã€â†’ã€Œã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯ã€ã‚’é¸æŠ
3. ã€Œæ–°ã—ã„ã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ç”Ÿæˆã•ã‚ŒãŸ URL ã‚’ `DISCORD_WEBHOOK` ã«è¨­å®š

**â€» Webhook URL ã¯æ©Ÿå¯†æƒ…å ±ã§ã™ã€‚ç¬¬ä¸‰è€…ã«å…±æœ‰ã—ãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚**
:::

### Cloudflare Turnstile ã®è¨­å®š

1. [Cloudflare ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://dash.cloudflare.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã€ŒTurnstileã€ã‚’é¸æŠ
3. ã€ŒAdd Widgetã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ä»¥ä¸‹ã‚’è¨­å®šï¼š
   - Widget name: ä»»æ„
   - Add Hostnames: `localhost:3000`ï¼ˆé–‹ç™ºç’°å¢ƒã®å ´åˆï¼‰
5. ã€ŒCreateã€ã‚’ã‚¯ãƒªãƒƒã‚¯
6. è¡¨ç¤ºã•ã‚ŒãŸ Site Key ã¨ Secret Key ã‚’ç’°å¢ƒå¤‰æ•°ã¸è¨­å®š

## å®Ÿè£…

### Session ã®ä½œæˆ

```ts:lib/session.ts
export interface SessionData {
    csrfToken?: string;
    code?: string;
}

import { SessionOptions } from "iron-session";

export const sessionOptions: SessionOptions = {
    password: process.env.SESSION_PASSWORD!,
    cookieName: "discord-verify-session",
    cookieOptions: {
        secure: process.env.NODE_ENV === "production",
        httpOnly: true,
        sameSite: "lax",
        path: "/",
        maxAge: 60 * 60,
    },
};
```

`iron-session` ã‚’ç”¨ã„ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¨­å®šã—ã¾ã™ã€‚

#### password

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æš—å·åŒ–ã«ä½¿ç”¨ã—ã¾ã™ã€‚

#### secure

`process.env.NODE_ENV === "production"` ã¨ã™ã‚‹ã“ã¨ã§ã€æœ¬ç•ªç’°å¢ƒã®ã¿ HTTPS ãŒå¿…é ˆã«ãªã‚Šã¾ã™ã€‚

#### httpOnly

é€šå¸¸ã¯ `document.cookie` ãªã©ã® JavaScript ã‹ã‚‰ Cookie ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ãŒã€`httpOnly` ã‚’æŒ‡å®šã™ã‚‹ã¨ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

#### sameSite

CSRF æ”»æ’ƒå¯¾ç­–ã§ä½¿ç”¨ã—ã¾ã™ã€‚
**strict**
åŒä¸€ã‚µã‚¤ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿ Cookie ã‚’é€ä¿¡ã—ã¾ã™ã€‚
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ƒ | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ˆ | GET | POST | ãƒªãƒ³ã‚¯ |
| --- | --- | --- | --- | --- |
| example.com | example.com | âœ… | âœ… | âœ… |
| other.com | other.com | âŒ | âŒ | âŒ |

**lax**ï¼ˆä»Šå›ä½¿ç”¨ï¼‰
å¤–éƒ¨ã‚µã‚¤ãƒˆã‹ã‚‰ã® POST ä»¥å¤–ã§ Cookie ã‚’é€ä¿¡ã—ã¾ã™ã€‚
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ƒ | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ˆ | GET | POST | ãƒªãƒ³ã‚¯ |
| --- | --- | --- | --- | --- |
| example.com | example.com | âœ… | âŒ | âœ… |
| other.com | other.com | âœ… | âŒ | âœ… |

**none**ï¼ˆéæ¨å¥¨ï¼‰
ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ Cookie ã‚’é€ä¿¡ã—ã¾ã™ã€‚
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ƒ | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ˆ | GET | POST | ãƒªãƒ³ã‚¯ |
| --- | --- | --- | --- | --- |
| example.com | example.com | âœ… | âœ… | âœ… |
| other.com | other.com | âœ… | âœ… | âœ… |

### OAuth 2 ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å‡¦ç†

```ts:app/api/callback/route.ts
import { NextRequest, NextResponse } from "next/server";
import { getIronSession } from "iron-session";
import { sessionOptions } from "@/lib/session";
import { SessionData } from "@/lib/type";
import crypto from "crypto";

export async function GET(req: NextRequest) {
  const res = new NextResponse();
  try {
    const session = await getIronSession<SessionData>(req, res, sessionOptions);
    const code = new URL(req.url).searchParams.get("code");

    if (!code) {
      throw new Error("No code provided");
    }

    const csrfToken = crypto.randomBytes(32).toString("hex");

    session.code = code;
    session.csrfToken = csrfToken;
    await session.save();

    return createRedirectResponse("/verify", res);
  } catch (error) {
    console.log("Error in api/callback:", error);
    return createRedirectResponse("/error", res);
  }
}
```

Discord OAuth 2 èªè¨¼å¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‡¦ç†ã—ã¾ã™ã€‚èªè¨¼ãŒæˆåŠŸã™ã‚‹ã¨ã€Discord ã¯æŒ‡å®šã—ãŸãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI ã« `code` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜ä¸ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚

1. å…ˆã»ã©ä½œæˆã—ãŸ `sessionOptions` ã¨ `req` / `res` ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
2. 32 ãƒã‚¤ãƒˆã® CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆï¼ˆhex å¤‰æ›ï¼‰
3. ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ `code` ã‚’å–å¾—
4. CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã¨ `code` ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸ä¿å­˜ â†’ `await session.save()`
5. æˆåŠŸã—ãŸã‚‰ `/verify` ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã€Cookie ã‚‚è»¢é€

```ts
function createRedirectResponse(path: string, res: NextResponse): NextResponse {
  const redirectUrl = new URL(path, process.env.BASE_URL)
  const response = NextResponse.redirect(redirectUrl)

  const cookie = res.headers.get('Set-Cookie')
  if (cookie) {
    response.headers.set('Set-Cookie', cookie)
  }

  return response
}
```

### æ¤œè¨¼ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒå¿…è¦ãªç†ç”±

ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ä¸€æ–¹ã€Cloudflare Turnstile ã‚„ React ã®çŠ¶æ…‹ç®¡ç†ï¼ˆ`useState`ï¼‰ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§å‹•ä½œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ä¸€åº¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã¾ã™ã€‚

### æ¤œè¨¼ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

https://github.com/yuk228/Discord-Oauth2-Web-Verify/blob/main/app/verify/page.tsx

#### 1. `/api/csrf` ã¸ GET ã— CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—

`api/csrf` ã« GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å«ã¾ã‚Œã‚‹ CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚
ã“ã‚Œã¯ `useEffect` ã‚’ä½¿ã£ã¦ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```ts
useEffect(() => {
  const fetchCsrfToken = async () => {
    try {
      const res = await fetch('/api/csrf', {
        method: 'GET',
        credentials: 'include',
        headers: {
          Accept: 'application/json',
        },
      })
      if (!res.ok) {
        throw new Error('Failed to fetch CSRF token')
      }
      const data = await res.json()
      setCsrfToken(data.csrfToken)
    } catch (error) {
      console.error('Error fetching CSRF token:', error)
      router.push('/error')
    }
  }
  fetchCsrfToken()
}, [router])
```

React ã® useState()ã‚’ç”¨ã„ã¦ csrf token ã‚’ state ã«ä¿å­˜ã—ã¾ã™ã€‚

```ts
const [csrfToken, setCsrfToken] = useState<string | null>(null)
```

#### 3. Cloudflare Turnstile ã®è¡¨ç¤ºã¨æ¤œè¨¼ã€token ã®ä¿å­˜

`next-turnstile`ã‚’ä½¿ç”¨ã—ã¦ UI ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

```ts
<Turnstile
  siteKey={process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY as string}
  onVerify={token => {
    setToken(token)
  }}
/>
```

onVerify()ã§èªè¨¼å®Œäº†æ™‚ã€token ã‚’ state ä¿å­˜ã—ã¾ã™ã€‚

#### 4. èªè¨¼ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã€csrf token ã¨ token ã‚’`api/verify`ã« POST

state ã‹ã‚‰ csrf token, token ã‚’å–å¾—ã—ã€headers ã®`X-CSRF-TOKEN`ã¨ body ã«ãã‚Œãã‚Œè¨­å®šã—ã¦`api/verify`ã« POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚

èªè¨¼ã«æˆåŠŸã—ãŸã‚‰`/success`ã«ã€å¤±æ•—ã—ãŸã‚‰`/error`ã«é·ç§»ã—ã¾ã™ã€‚

```ts
  const handleVerify = async () => {
    if (!token || !csrfToken) return;
    try {
      const res = await fetch("/api/verify", {
        method: "POST",
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken,
        },
        body: JSON.stringify({
          token,
        }),
      });

      const result = await res.json();

      if (result.status === 200) {
        router.push("/success");
      } else {
        router.push("/error");
      }
    } catch {
      router.push("/error");
    }
```

### Suspense ã¨ã¯

```ts
export default function VerifyPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <Verify />
    </Suspense>
  )
}
```

Suspense ã¨ã¯ã€**ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒ­ãƒ¼ãƒ‰ä¸­ã®æ™‚ã«åˆ¥ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€ä»•çµ„ã¿**ã§ã™ã€‚
ä»Šå›ã¯ã€ãƒ­ãƒ¼ãƒ‰ä¸­ã«`<div>Loading...</div>`ã‚’è¡¨ç¤ºã•ã›ã€çµ‚ã‚ã‚Šæ¬¡ç¬¬`<Verify />`ã‚’è¡¨ç¤ºã•ã›ã¦ã„ã¾ã™ã€‚

ãªã‚“ã§ã“ã‚Œã‚’æ€¥ã«ä½¿ã£ãŸã‹ã¨ã„ã†ã¨ã€`useSearchParams()`ä½¿ç”¨æ™‚ã«ã¯ Suspense ã§å›²ã‚ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã‹ã‚‰ã§ã™ã€‚
å®Ÿéš›ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```
useSearchParams() should be wrapped in a suspense boundary at page "/verify". | useSearchParams() ã¯ã€ãƒšãƒ¼ã‚¸ "/verify" ã®ã‚µã‚¹ãƒšãƒ³ã‚¹å¢ƒç•Œã§å›²ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```

`useSearchParams()`ä½¿ç”¨æ™‚ã«ãƒšãƒ¼ã‚¸å…¨ä½“ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«è¨­å®šã•ã‚Œã€**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã® JavaScript ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§ãƒšãƒ¼ã‚¸ãŒç©ºç™½ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹**ã‹ã‚‰ã¨ã®ã“ã¨ã€‚

https://nextjs.org/docs/messages/missing-suspense-with-csr-bailout

### æ¤œè¨¼å‡¦ç†ã®å®Ÿè£…

#### Turnstile ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼

```ts:lib/functions/verify.ts
export async function verifyToken(token: string) {
  try {
    const verificationResponse = await fetch(
      "https://challenges.cloudflare.com/turnstile/v0/siteverify",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          secret: process.env.TURNSTILE_SECRET_KEY as string,
          response: token,
        }),
      }
    );

    if (!verificationResponse.ok) {
      throw new Error("Failed to verify token");
    }

    return await verificationResponse.json();
  } catch (error) {
    console.log("Error in verify csrf token:", error);
    throw error;
  }
}
```

ã“ã®é–¢æ•°ã¯ã€Cloudflare Turnstile ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦æ¤œè¨¼ API ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€çµæœã‚’è¿”ã—ã¾ã™ã€‚

#### Discord ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—

```ts:lib/functions/verify.ts
export async function getToken(code: string) {
  try {
    const body = new URLSearchParams({
      grant_type: "authorization_code",
      code: code,
      redirect_uri: `${process.env.BASE_URL}/api/callback`,
    }).toString();

    const token = await fetch(`https://discord.com/api/v10/oauth2/token`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        Authorization:
          "Basic " +
          Buffer.from(`${process.env.CLIENT_ID}:${process.env.CLIENT_SECRET}`).toString("base64"),
      },
      body: body,
    });

    if (!token.ok) {
      throw new Error("Failed to fetch token");
    }

    return await token.json();
  } catch (error) {
    console.log("Error in get token from discord:", error);
    throw error;
  }
}
```

ã“ã®é–¢æ•°ã¯ã€OAuth 2 ã®èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ Discord ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚åŒæ™‚ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚å–å¾—ã§ãã¾ã™ãŒã€ä»Šå›ã¯ä¸€æ™‚çš„ãªèªè¨¼ã®ã¿ã‚’è¡Œã†ãŸã‚ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚
:::message
ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†å–å¾—ã™ã‚‹éš›ã«åˆ©ç”¨ã§ãã¾ã™ã€‚
:::

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—

#### å‹å®šç¾©

```ts:lib/type.ts
export interface DiscordUser {
  id: number;
  username: string;
  global_name: string;
  avatar_id: string;
  locale: string;
  mfa_enabled: boolean;
}
```

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—é–¢æ•°

```ts:lib/functions/get-info.ts
import { DiscordUser } from "../type";

export async function getInfo(accessToken: string): Promise<DiscordUser> {
  try {
    const res = await fetch(`https://discord.com/api/users/@me`, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    });
    const userInfo = await res.json();
    return userInfo as DiscordUser;
  } catch (error) {
    console.log("Error in getInfo:", error);
    throw error;
  }
}
```

ã“ã®é–¢æ•°ã¯ã€å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ Discord API ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚

### ãƒ­ãƒ¼ãƒ«ã®ä»˜ä¸

```ts:lib/functions/assign-role.ts
export async function assignRole(userId: string) {
  try {
    const guildId = process.env.DISCORD_GUILD_ID;
    const roleId = process.env.DISCORD_ROLE_ID;
    const botToken = process.env.DISCORD_BOT_TOKEN;

    const res = await fetch(
      `https://discord.com/api/v10/guilds/${guildId}/members/${userId}/roles/${roleId}`,
      {
        method: "PUT",
        headers: {
          Authorization: `Bot ${botToken}`,
          "Content-Type": "application/json",
        },
      }
    );

    if (!res.ok) {
      throw new Error("Failed to assign role");
    }
  } catch (error) {
    console.log("Error in assign role:", error);
    throw error;
  }
}
```

ã“ã®é–¢æ•°ã¯ã€èªè¨¼ãŒæˆåŠŸã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æŒ‡å®šã—ãŸãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

### ãƒ­ã‚°ã®é€ä¿¡

```ts:lib/functions/logger.ts
import { DiscordUser } from "../type";

export async function logger(userInfo: DiscordUser) {
    try {
        const webhookUrl = process.env.DISCORD_WEBHOOK || "";

        const fields = [
            {
                name: "ğŸ‘¤ãƒ¦ãƒ¼ã‚¶ãƒ¼",
                value: `${userInfo.global_name}(${userInfo.username || userInfo.username})`,
                inline: false,
            },
            {
                name: "âœ‰ï¸ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±",
                value: `ID: \`${userInfo.id}\`\nè¨€èª: \`${userInfo.locale}\`\nMFA: \`${userInfo.mfa_enabled}\``,
                inline: false,
            },
        ];

        const embed = {
            title: "âœ…èªè¨¼æˆåŠŸ",
            fields: fields,
            thumbnail: {
                url: `https://cdn.discordapp.com/avatars/${userInfo.id}/${userInfo.avatar_id}.png`,
            },
            color: 0x7e22d2,
            timestamp: new Date().toISOString(),
        };

        const response = await fetch(webhookUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                embeds: [embed],
            }),
        });

        if (!response.ok) {
            throw new Error("Webhook request failed");
        }
    } catch (error) {
        console.log("Error in logger:", error);
        throw error;
    }
}
```

ã“ã®é–¢æ•°ã¯ã€èªè¨¼æˆåŠŸæ™‚ã« Discord Webhook ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚’é€ä¿¡ã—ã¾ã™ã€‚
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰å–å¾—ã—ãŸæƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

### æ¤œè¨¼ API ã®å®Ÿè£…

```ts:app/api/verify/route.ts
import { logger } from "@/lib/functions/logger";
import { NextRequest, NextResponse } from "next/server";
import { assignRole } from "@/lib/functions/assign-role";
import { getInfo } from "@/lib/functions/get-info";
import { getToken, verifyToken } from "@/lib/functions/verify";
import { getIronSession } from "iron-session";
import { sessionOptions } from "@/lib/session";
import { SessionData } from "@/lib/type";

export async function POST(req: NextRequest) {
  const res = new NextResponse();
  const session = await getIronSession<SessionData>(req, res, sessionOptions);
  try {
    const body = await req.json();
    const { token } = body;
    const csrfToken = req.headers.get("X-CSRF-Token");

    if (!token || !csrfToken || !session.code) {
      console.log("Missing required parameters: token, csrfToken, or session.code not found");
      return NextResponse.json({ status: 400 });
    }

    if (!session.csrfToken || session.csrfToken !== csrfToken) {
      console.log("CSRF token is incorrect");
      return NextResponse.json({ status: 400 });
    }

    await verifyToken(token);
    const getTokenResult = await getToken(session.code as string);
    const userInfo = await getInfo(getTokenResult.access_token);
    await assignRole(userInfo.id.toString());
    await logger(userInfo);

    session.code = undefined;
    session.csrfToken = undefined;
    await session.save();

    return NextResponse.json({ status: 200 });
  } catch (error) {
    console.log("Error in /api/verify:", error);

    session.code = undefined;
    session.csrfToken = undefined;
    await session.save();

    return NextResponse.json({ status: 500 });
  }
}

```

ã“ã® API ã¯ä»¥ä¸‹ã®æ‰‹é †ã§èªè¨¼ã‚’å‡¦ç†ã—ã¾ã™ï¼š

1. CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼
2. Turnstile ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼
3. Discord ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—
5. ãƒ­ãƒ¼ãƒ«ã®ä»˜ä¸
6. ãƒ­ã‚°ã®é€ä¿¡

## error/success ãƒšãƒ¼ã‚¸ã®ä½œæˆ

```ts:app/success/page.tsx
export default function Success() {
    return (
        <main className="flex min-h-screen items-center justify-center">
            <div className="p-10 rounded-4xl md:w-1/2 max-w-md border border-white/[0.10]">
                <div className="mx-auto">
                    <h1 className="text-xl font-bold mb-4 text-center">èªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ</h1>
                    <p className="text-center text-muted-foreground mb-6">
                        èªè¨¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚ã“ã®ãƒšãƒ¼ã‚¸ã¯é–‰ã˜ã¦æ§‹ã„ã¾ã›ã‚“ã€‚
                    </p>
                </div>
            </div>
        </main>
    )
}
```

```ts:app/error/page.tsx
export default function Error() {
    return (
        <main className="flex min-h-screen items-center justify-center">
            <div className="p-10 rounded-4xl md:w-1/2 max-w-md border border-white/[0.10]">
                <div className="mx-auto">
                    <h1 className="text-xl font-bold mb-4 text-center">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h1>
                    <p className="text-center text-muted-foreground mb-6">
                        èªè¨¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
                    </p>
                </div>
            </div>
        </main>
    )
}
```

ãŠå¥½ã¿ã§ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã—ã¦ä¸‹ã•ã„ã€‚

## ã¾ã¨ã‚

æœ¬ç¨¿ã§ã¯ã€Discord OAuth 2 ã¨ Cloudflare Turnstile ã‚’çµ„ã¿åˆã‚ã›ãŸã‚»ã‚­ãƒ¥ã‚¢ãª Web èªè¨¼ã‚¢ãƒ—ãƒªã®ä½œã‚Šæ–¹ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— BOT ã®ä½œæˆãªã©ã€æ§˜ã€…ãªã“ã¨ã«å¿œç”¨å‡ºæ¥ã‚‹ã¨æ€ã„ã¾ã™ã®ã§ã€æ°—ã«ãªã‚‹æ–¹ã¯è©¦ã—ã¦ã¿ã¦ä¸‹ã•ã„ã€‚
