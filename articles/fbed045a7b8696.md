---
title: 'VPNã‚’æ¤œçŸ¥ã™ã‚‹ | Next.js'
published: true
type: tech
emoji: 'ğŸ›¡ï¸'
topics: ['nextjs', 'react', 'vpn']
---

# ã¯ã˜ã‚ã«

Web ã‚µã‚¤ãƒˆã®è‡ªå‹•åŒ–ã‚„åŒ¿ååŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ä¸å¿«æ„Ÿã‚’æŠ±ãã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ
VPN ã‚„ Tor ã¯å€‹äººã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’å®ˆã‚Šã¾ã™ãŒã€åŒæ™‚ã«èº«å…ƒã‚’éš ã™æ‰‹æ®µã¨ã—ã¦æ‚ªç”¨ã•ã‚Œã‚„ã™ã„ã¨ã„ã†èª²é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

VPN ã‚„ Proxy ã® IP ã‚’æ¤œçŸ¥ã™ã‚‹ API ã‚µãƒ¼ãƒ“ã‚¹ã¯å¤šæ•°ã‚ã‚Šã¾ã™ãŒã€å¤šããŒæœ‰æ–™ã¾ãŸã¯åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚

ãƒãƒ¼ã‚³ã‚¹ãƒˆã§æ¤œçŸ¥ãŒå¯èƒ½ãª API ã‚’ä½œæˆã—ãŸã®ã§ã€å…±æœ‰ã—ã¾ã™ã€‚

å®Œæˆå“ â†“
https://vpn-detect-api.vercel.app/api

:::message
ä½å®… IP ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸ Proxy ã®åˆ¤å®šã¯ã§ãã¾ã›ã‚“ã€‚
:::

# ãƒ­ã‚¸ãƒƒã‚¯

GitHub ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã® ASNï¼ˆAutonomous System Numberï¼‰ãƒªã‚¹ãƒˆã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

1. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ IP ã®å–å¾—**

   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚

2. **ASN ã®å–å¾—**

   - å–å¾—ã—ãŸ IP ã‚’`ipinfo.io`ã«é€ä¿¡ã—ã€å¯¾å¿œã™ã‚‹ ASN ã‚’å–å¾—ã—ã¾ã™ã€‚

3. **åˆ¤å®š**
   - å–å¾—ã—ãŸ ASN ãŒæº–å‚™ã—ãŸ ASN ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚Œã°`True`ï¼ˆVPN/Proxy ã¨åˆ¤å®šï¼‰ã¨ã—ã¾ã™ã€‚

æ¤œè¨¼å›æ•°ãŒå¤šã„å ´åˆã€æ‰‹é † 2 ã§ API ãƒªãƒŸãƒƒãƒˆãŒã‹ã‘ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ä»–ã®å–å¾—æ–¹æ³•ã‚’ã”å­˜çŸ¥ã®æ–¹ã¯ãã¡ã‚‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

# å®Ÿè£…

Next.js ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å°å…¥ã—ãŸã‚‚ã®ã‚’æµç”¨ã—ãŸãŸã‚ã€Next.js ã§ä½œæˆã—ã¦ã„ã¾ã™ã€‚

## ASN ãƒªã‚¹ãƒˆã‚’å–å¾—

GitHub ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ ASN ãƒªã‚¹ãƒˆã‚’å°‘ã—æ”¹å¤‰ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚
https://github.com/yuk228/vpn-detect-api/blob/main/lib/asn.json

å…ƒã®ãƒ‡ãƒ¼ã‚¿ã¯ã“ã¡ã‚‰ã§ã™ã€‚
https://github.com/NullifiedCode/ASN-Lists

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ IP ã‹ã‚‰ ASN ã‚’å–å¾—

```ts:isVpn.ts
export async function getASN(ip: string): Promise<number | null> {
  try {
    const response = await fetch(`https://ipinfo.io/${ip}/json`);
    if (!response.ok) {
      console.error("Failed to fetch ASN");
      return null;
    }
    const data = await response.json();
    const match = data.org?.match(/AS(\d+)/);
    if (match && match[1]) {
      return parseInt(match[1], 10);
    }
    console.error("No ASN found");
    return null;
  } catch (error) {
    console.error(error);
    return null;
  }
}
```

`ipinfo.io`ã« IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é€ä¿¡ã—ã¦`fetch`ã—ã€çµæœã‚’å–å¾—ã—ã¾ã™ã€‚
IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’`1.1.1.1`ã¨ã—ãŸå ´åˆã®`response.json()`ã®ã‚µãƒ³ãƒ—ãƒ«ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```json
{
  "ip": "1.1.1.1",
  "hostname": "one.one.one.one",
  "city": "Brisbane",
  "region": "Queensland",
  "country": "AU",
  "loc": "-27.4816,153.0175",
  "org": "AS13335 Cloudflare, Inc.",
  "postal": "4101",
  "timezone": "Australia/Brisbane",
  "readme": "https://ipinfo.io/missingauth",
  "anycast": true
}
```

ã“ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ ASN ã‚’å–å¾—ã—ã¦è¿”ã—ã¾ã™ã€‚

## VPN ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã™ã‚‹

```ts:isVpn.ts
import asnList from "@/lib/asn.json";

export async function isVpn(ip: string): Promise<boolean> {
  const asn = await getASN(ip);
  if (!asn) return false;
  return asnList.includes(asn);
}
```

å…ˆã»ã©ä½œæˆã—ãŸé–¢æ•°`getASN`ã‚’ä½¿ç”¨ã—ã¦ ASN ã‚’å–å¾—ã—ã€`asn.json`ã«å«ã¾ã‚Œã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

## IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œè¨¼

```ts:ipValidate.ts
export function isValidIPv4(ip: string): boolean {
  const IPV4_REGEX =
    /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
  if (!IPV4_REGEX.test(ip)) return false;

  const octets = ip.split(".");
  return octets.every((octet) => {
    return octet === "0" || !octet.startsWith("0");
  });
}
```

é€ä¿¡ã•ã‚ŒãŸ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ­£å¸¸ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ã¾ã™ã€‚
IPv4 ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

## API ã®ä½œæˆ

```ts:app/api/[ip]/route.ts
import { NextResponse } from "next/server";
import { isVpn } from "@/lib/isVpn";
import { isValidIPv4 } from "@/lib/ipValidate";

export async function GET(request: Request, { params }: { params: Promise<{ ip: string }> }) {
  const { ip } = await params;
  if (!isValidIPv4(ip)) {
    return NextResponse.json({ error: "invalid ip address" }, { status: 400 });
  }
  const vpnCheck = await isVpn(ip);
  if (!vpnCheck) {
    return NextResponse.json({
      ip,
      isVpn: false,
    });
  }

  return NextResponse.json({
    ip,
    isVpn: true,
  });
}
```

ã“ã‚Œã¾ã§ä½œæˆã—ãŸé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ API ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

## å‹•ä½œç¢ºèª

å®Œæˆã—ãŸ API ã‚’è©¦ã—ã«ä½¿ç”¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
VPN ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚¤ã‚¹ãƒ©ã‚¨ãƒ«ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```json:
{"ip":"169.150.227.226","isVpn":true}
```

ç„¡äº‹åˆ¤å®šã•ã‚Œã¾ã—ãŸã€‚

# æœ€å¾Œã«

ä»¥ä¸Šã§å®Ÿè£…ã¯å®Œäº†ã§ã™ã€‚
è‡ªå‹•åŒ–å¯¾ç­–ã«ã¯å¿…é ˆãƒ¬ãƒ™ãƒ«ã® VPN/Proxy æ¤œçŸ¥ã«ä¾¿åˆ©ã ã¨æ€ã„ã¾ã™ã€‚
Discord ã‚µãƒ¼ãƒãƒ¼ã® Web èªè¨¼ãªã©ã«è¨­ç½®ã—ã¦ã¿ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚
